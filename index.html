<script>
async function fetchEndpoints() {
  const url = "https://raw.githubusercontent.com/F0rc3Run/free-warp-endpoints/refs/heads/main/docs/results.json";
  const res = await fetch(url);
  const data = await res.json();
  return data.ipv4;
}

async function testEndpoint(ep) {
  const target = `https://${ep}`;
  const start = performance.now();
  try {
    await fetch(target, { mode: 'no-cors', cache: 'no-store' });
    const end = performance.now();
    return Math.round(end - start);
  } catch {
    return null;
  }
}

document.getElementById("startBtn").addEventListener("click", async () => {
  const btn = document.getElementById("startBtn");
  btn.disabled = true;
  btn.textContent = "در حال تست...";

  const endpoints = await fetchEndpoints();

  // همه رو همزمان تست می‌کنیم
  const promises = endpoints.map(async ep => {
    const latency = await testEndpoint(ep);
    return { ep, latency };
  });

  const results = await Promise.all(promises);

  // مرتب‌سازی از سریع به کند
  results.sort((a, b) => (a.latency || 9999) - (b.latency || 9999));

  renderTable(results);
  btn.textContent = "تست دوباره";
  btn.disabled = false;
});

function renderTable(data) {
  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const colorClass = !r.latency ? 'fail' :
                       r.latency < 150 ? 'fast' :
                       r.latency < 400 ? 'medium' : 'slow';
    const row = document.createElement("tr");
    row.innerHTML = `<td>${r.ep}</td><td class="${colorClass}">${r.latency ? r.latency + " ms" : "Fail"}</td>`;
    tbody.appendChild(row);
  });
}
</script>
