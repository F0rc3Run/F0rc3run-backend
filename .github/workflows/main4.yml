name: Check Proxies and Update Results

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Private Checker Repo
        uses: actions/checkout@v4
        with:
          repository: F0rc3Run/xray-checker
          token: ${{ secrets.PAT }}
          path: xray-checker

      - name: ðŸ”½ Download and Setup Xray
        working-directory: ./xray-checker
        run: |
          echo "Downloading latest Xray-core..."
          wget -q -O xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -o xray.zip xray
          chmod +x xray
          rm xray.zip
          echo "Xray setup complete."

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Install Dependencies
        run: pip install -r xray-checker/requirements.txt

      - name: ðŸš€ Run Checker and Generate Outputs
        working-directory: ./xray-checker
        run: python main.py

      - name: ðŸ“ Check for Results
        id: check_results
        run: |
          if [ -d "xray-checker/output" ] && [ -n "$(ls -A xray-checker/output)" ]; then
            echo "results_exist=true" >> "$GITHUB_OUTPUT"
          else
            echo "results_exist=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ“¤ Push to Public Repo
        if: steps.check_results.outputs.results_exist == 'true'
        uses: cpina/github-action-push-to-another-repo@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          source-directory: 'xray-checker/output'
          destination-github-username: 'F0rc3Run'
          destination-repository-name: 'F0rc3Run'
          user-email: 'actions@github.com'
          user-name: 'GitHub Actions'
          commit-message: 'Update proxy servers'
          target-directory: 'Best-Results' # Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ Ø¬Ø¯ÛŒØ¯
