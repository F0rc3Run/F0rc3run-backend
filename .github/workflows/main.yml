name: WARP Endpoint Scanner
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget iproute2 net-tools
          
      - name: Configure network interfaces
        run: |
          # نمایش اینترفیس‌های موجود
          ip addr show
          
          # اضافه کردن آدرس IPv4 به eth0
          sudo ip addr add 192.168.1.1/24 dev eth0
          
          # اضافه کردن آدرس IPv6 به eth0
          sudo ip -6 addr add 2001:db8::1/64 dev eth0
          
          # تنظیم مسیر پیش‌فرض برای IPv4
          sudo ip route add default via 192.168.1.254 dev eth0 metric 100
          
          # تنظیم مسیر پیش‌فرض برای IPv6
          sudo ip -6 route add default via 2001:db8::fffe dev eth0 metric 100
          
          # بررسی مجدد اینترفیس‌ها
          ip addr show eth0
          ip route show
          ip -6 route show
          
      - name: Download warp script
        run: |
          curl -o warp-go.sh https://gitlab.com/fscarmen/warp/-/raw/main/warp-go.sh
          chmod +x warp-go.sh
          
      - name: Run warp scan
        run: |
          echo "شروع اسکن WARP..."
          echo "اینترفیس‌های شبکه فعلی:"
          ip addr show
          
          # اجرای اسکریپت با خروجی دقیق‌تر
          sudo ./warp-go.sh scan > warp_results.txt 2>&1 || echo "اسکن با خطا انجام شد"
          echo "اسکن WARP پایان یافت"
        continue-on-error: true
        env:
          # تنظیم متغیرهای محیطی برای فریب اسکریپت
          WARP_IFACE: "eth0"
          
      - name: Process results
        run: |
          echo "پردازش نتایج..."
          
          # نمایش کامل نتایج برای دیباگ
          echo "=== محتوای کامل warp_results.txt ==="
          cat warp_results.txt
          
          # استخراج اندپوینت‌های معتبر
          if grep -qE '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' warp_results.txt; then
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' warp_results.txt | head -20 > best_endpoints.txt
          else
            echo "هیچ اندپوینت معتبری یافت نشد" > best_endpoints.txt
          fi
          
          # ایجاد فایل JSON
          echo "[" > endpoints.json
          if [ -s best_endpoints.txt ] && ! grep -q "هیچ اندپوینت معتبری یافت نشد" best_endpoints.txt; then
            counter=0
            while IFS= read -r line; do
              if [ $counter -gt 0 ]; then
                echo "," >> endpoints.json
              fi
              ip=$(echo $line | awk '{print $1}')
              port=$(echo $line | awk '{print $2}')
              ping=$(echo $line | awk '{print $3}')
              echo "  {\"ip\": \"$ip\", \"port\": \"$port\", \"ping\": \"$ping\"}" >> endpoints.json
              counter=$((counter+1))
            done < best_endpoints.txt
          fi
          echo "]" >> endpoints.json
          echo "پردازش نتایج پایان یافت"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: warp-scan-results
          path: |
            warp_results.txt
            best_endpoints.txt
            endpoints.json
        continue-on-error: true
        
      - name: Commit results
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add best_endpoints.txt endpoints.json
          if git diff --staged --quiet; then
            echo "هیچ تغییری برای commit وجود ندارد"
          else
            git commit -m "به‌روزرسانی اندپوینت‌های WARP [$(date '+%Y-%m-%d %H:%M')]"
            git push
          fi
        continue-on-error: true
        
      - name: Debug info
        if: always()
        run: |
          echo "=== اطلاعات دیباگ ==="
          echo "دایرکتوری فعلی: $(pwd)"
          echo "فایل‌های موجود:"
          ls -la
          echo "=== اینترفیس‌های شبکه ==="
          ip addr show
          echo "=== مسیرهای IPv4 ==="
          ip route show
          echo "=== مسیرهای IPv6 ==="
          ip -6 route show
          echo "=== محتوای warp_results.txt ==="
          cat warp_results.txt || echo "فایل warp_results.txt یافت نشد"
          echo "=== محتوای best_endpoints.txt ==="
          cat best_endpoints.txt || echo "فایل best_endpoints.txt یافت نشد"
          echo "=== محتوای endpoints.json ==="
          cat endpoints.json || echo "فایل endpoints.json یافت نشد"
