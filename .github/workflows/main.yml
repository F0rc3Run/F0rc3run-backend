name: WARP Endpoint Scanner

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # افزایش زمان تایم‌اوت
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget iproute2 net-tools
        continue-on-error: true  # ادامه حتی در صورت خطا

      - name: Download warp script
        run: |
          curl -o warp-go.sh https://gitlab.com/fscarmen/warp/-/raw/main/warp-go.sh
          chmod +x warp-go.sh

      - name: Run warp scan
        run: |
          echo "Starting WARP scan..."
          ./warp-go.sh scan > warp_results.txt 2>&1 || echo "Scan completed with some errors"
          echo "WARP scan finished"
        continue-on-error: true

      - name: Process results
        run: |
          echo "Processing results..."
          # استخراج اندپوینت‌های سالم
          grep -E '^[0-9]' warp_results.txt | head -20 > best_endpoints.txt || echo "No endpoints found"
          
          # ایجاد فایل JSON برای استفاده‌های بعدی
          echo "[" > endpoints.json
          if [ -s best_endpoints.txt ]; then
            grep -E '^[0-9]' best_endpoints.txt | while read line; do
              ip=$(echo $line | awk '{print $1}')
              port=$(echo $line | awk '{print $2}')
              ping=$(echo $line | awk '{print $3}')
              echo "  {\"ip\": \"$ip\", \"port\": \"$port\", \"ping\": \"$ping\"}," >> endpoints.json
            done
          fi
          echo "]" >> endpoints.json
          echo "Results processing completed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: warp-scan-results
          path: |
            warp_results.txt
            best_endpoints.txt
            endpoints.json
        continue-on-error: true

      - name: Commit results
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add best_endpoints.txt endpoints.json
          git commit -m "Update warp endpoints [$(date '+%Y-%m-%d %H:%M')]" || echo "No changes to commit"
          git push || echo "Push failed"
        continue-on-error: true

      - name: Debug info
        if: always()
        run: |
          echo "=== Debug Information ==="
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          echo "=== warp_results.txt (first 10 lines) ==="
          head -n 10 warp_results.txt || echo "warp_results.txt not found"
          echo "=== best_endpoints.txt (first 10 lines) ==="
          head -n 10 best_endpoints.txt || echo "best_endpoints.txt not found"
          echo "=== endpoints.json (first 10 lines) ==="
          head -n 10 endpoints.json || echo "endpoints.json not found"
