name: Find Clean WARP Endpoints via Dynamic Iran Proxy

on:
  workflow_dispatch:

jobs:
  scan-endpoints:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Dependencies
        run: |
          echo "Downloading sing-box client and WARP scanner..."
          # دانلود sing-box
          wget -O sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v1.12.0/sing-box-1.12.0-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz
          cp sing-box-1.12.0-linux-amd64/sing-box .
          chmod +x sing-box
          
          # دانلود اسکنر
          wget -O warp-scanner.zip https://github.com/irani/WARP-Endpoint-Scanner/releases/latest/download/WARP-Endpoint-Scanner-linux-amd64.zip
          unzip warp-scanner.zip
          chmod +x WARP-Endpoint-Scanner
          
      - name: Find and Connect to a Working Iran Proxy
        id: proxy_connect
        run: |
          echo "Fetching proxy list from URL..."
          curl -s -o ir_proxies.txt https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-country/IR.txt
          
          while IFS= read -r proxy_uri; do
            if [[ -z "$proxy_uri" ]]; then continue; fi

            echo "--- Testing proxy: $proxy_uri ---"
            
            # --- Parse VLESS URI ---
            # This part is complex and handles simple VLESS URIs
            # Note: It may not support all VLESS parameters
            address_part=$(echo "$proxy_uri" | cut -d'@' -f2 | cut -d'?' -f1)
            uuid=$(echo "$proxy_uri" | cut -d'/' -f3 | cut -d'@' -f1)
            server=$(echo "$address_part" | cut -d':' -f1)
            server_port=$(echo "$address_part" | cut -d':' -f2)

            if [[ -z "$uuid" || -z "$server" || -z "$server_port" ]]; then
              echo "Could not parse URI. Skipping."
              continue
            fi
            
            # --- Create sing-box config for the current proxy ---
            cat > config.json <<EOF
            {
              "inbounds": [{"type": "socks", "listen": "127.0.0.1", "listen_port": 1080}],
              "outbounds": [{
                "type": "vless",
                "server": "$server",
                "server_port": $server_port,
                "uuid": "$uuid"
              }]
            }
            EOF
            
            # --- Run and Test ---
            sudo ./sing-box run -c config.json > singbox.log 2>&1 &
            SINGBOX_PID=$!
            sleep 8 # Wait for connection
            
            echo "Verifying connection..."
            response=$(curl --socks5 127.0.0.1:1080 -s --max-time 10 http://ip-api.com/json)
            kill $SINGBOX_PID
            
            country=$(echo "$response" | jq -r .country)
            if [ "$country" == "Iran" ]; then
              echo "✅ SUCCESS: Found a working Iran proxy: $server"
              echo "proxy_found=true" >> $GITHUB_OUTPUT
              
              # Set up environment for subsequent steps
              PROXY_URL="socks5://127.0.0.1:1080"
              echo "https://_proxy=$PROXY_URL" >> $GITHUB_ENV
              echo "http_proxy=$PROXY_URL" >> $GITHUB_ENV
              echo "HTTPS_PROXY=$PROXY_URL" >> $GITHUB_ENV
              echo "HTTP_PROXY=$PROXY_URL" >> $GITHUB_ENV
              
              # Relaunch the working proxy to keep it running for the next steps
              sudo ./sing-box run -c config.json > singbox.log 2>&1 &
              exit 0 # Exit the script successfully to proceed to the next step
            else
              echo "❌ FAILED: Proxy did not connect or is not in Iran. Trying next..."
              echo "Response: $response"
            fi
            
          done < ir_proxies.txt

          echo "::error::No working Iran proxy found in the list."
          exit 1
          
      - name: Run WARP IP Scanner
        if: steps.proxy_connect.outputs.proxy_found == 'true'
        run: |
          echo "Starting the scan through the Iran proxy..."
          ./WARP-Endpoint-Scanner -o result.csv
          
          echo "Scan finished. Top 10 results:"
          head -n 11 result.csv

      - name: Upload Results as Artifact
        if: always() # Always run this step to get logs even if the scan fails
        uses: actions/upload-artifact@v4
        with:
          name: warp-scan-results
          path: |
            result.csv
            singbox.log
