name: WARP Endpoint Scanner
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget iproute2 net-tools
          
      - name: Create virtual network namespace
        run: |
          # ایجاد یک فضای نام شبکه مجازی
          sudo ip netns add warpns
          
          # ایجاد یک جفت اینترفیس مجازی
          sudo ip link add veth0 type veth peer name veth1
          
          # انتقال یک اینترفیس به فضای نام مجازی
          sudo ip link set veth1 netns warpns
          
          # پیکربندی اینترفیس در فضای نام اصلی
          sudo ip addr add 192.168.1.1/24 dev veth0
          sudo ip link set veth0 up
          
          # پیکربندی اینترفیس در فضای نام مجازی
          sudo ip netns exec warpns ip addr add 192.168.1.2/24 dev veth1
          sudo ip netns exec warpns ip link set veth1 up
          sudo ip netns exec warpns ip link set lo up
          
          # تنظیم مسیرها
          sudo ip netns exec warpns ip route add default via 192.168.1.1
          
          # فعال کردن forwarding
          sudo sysctl -w net.ipv4.ip_forward=1
          
          # تنظیم NAT برای دسترسی به اینترنت
          sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE
          
          # نمایش وضعیت شبکه
          echo "=== وضعیت شبکه در فضای نام اصلی ==="
          ip addr show veth0
          echo "=== وضعیت شبکه در فضای نام مجازی ==="
          sudo ip netns exec warpns ip addr show
          echo "=== مسیرها در فضای نام مجازی ==="
          sudo ip netns exec warpns ip route show
          
      - name: Download warp script and prepare binaries
        run: |
          # دانلود اسکریپت
          curl -o warp-go.sh https://gitlab.com/fscarmen/warp/-/raw/main/warp-go.sh
          chmod +x warp-go.sh
          
          # ایجاد دایرکتوری برای فایل‌های باینری
          sudo mkdir -p /tmp/warp-binaries
          
          # دانلود فایل‌های باینری در فضای نام اصلی
          echo "دانلود فایل‌های باینری WARP..."
          wget -O /tmp/warp-binaries/warp-go https://github.com/fscarmen/warp-go/releases/download/v1.2.0/warp-go-linux-amd64
          sudo chmod +x /tmp/warp-binaries/warp-go
          
          # کپی فایل‌های باینری به فضای نام مجازی
          sudo mkdir -p /tmp/warp-ns
          sudo cp /tmp/warp-binaries/warp-go /tmp/warp-ns/
          
          # ایجاد لینک به فایل باینری در فضای نام مجازی
          sudo ip netns exec warpns mkdir -p /tmp
          sudo ip netns exec warpns cp /tmp/warp-ns/warp-go /tmp/
          sudo ip netns exec warpns chmod +x /tmp/warp-go
          
          # بررسی فایل‌ها
          echo "=== بررسی فایل‌های باینری ==="
          ls -la /tmp/warp-binaries/
          echo "=== بررسی فایل‌ها در فضای نام مجازی ==="
          sudo ip netns exec warpns ls -la /tmp/warp-go
          
      - name: Run warp scan in virtual namespace
        run: |
          echo "شروع اسکن WARP..."
          
          # اجرای اسکریپت در فضای نام مجازی
          sudo ip netns exec warpns ./warp-go.sh scan > warp_results.txt 2>&1 || echo "اسکن با خطا انجام شد"
          echo "اسکن WARP پایان یافت"
        continue-on-error: true
        env:
          # تنظیم مسیر فایل باینری
          WARP_GO_PATH: "/tmp/warp-go"
          
      - name: Process results
        run: |
          echo "پردازش نتایج..."
          
          # نمایش کامل نتایج برای دیباگ
          echo "=== محتوای کامل warp_results.txt ==="
          cat warp_results.txt
          
          # استخراج اندپوینت‌های معتبر
          if grep -qE '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' warp_results.txt; then
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' warp_results.txt | head -20 > best_endpoints.txt
          else
            echo "هیچ اندپوینت معتبری یافت نشد" > best_endpoints.txt
          fi
          
          # ایجاد فایل JSON
          echo "[" > endpoints.json
          if [ -s best_endpoints.txt ] && ! grep -q "هیچ اندپوینت معتبری یافت نشد" best_endpoints.txt; then
            counter=0
            while IFS= read -r line; do
              if [ $counter -gt 0 ]; then
                echo "," >> endpoints.json
              fi
              ip=$(echo $line | awk '{print $1}')
              port=$(echo $line | awk '{print $2}')
              ping=$(echo $line | awk '{print $3}')
              echo "  {\"ip\": \"$ip\", \"port\": \"$port\", \"ping\": \"$ping\"}" >> endpoints.json
              counter=$((counter+1))
            done < best_endpoints.txt
          fi
          echo "]" >> endpoints.json
          echo "پردازش نتایج پایان یافت"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: warp-scan-results
          path: |
            warp_results.txt
            best_endpoints.txt
            endpoints.json
        continue-on-error: true
        
      - name: Commit results
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add best_endpoints.txt endpoints.json
          if git diff --staged --quiet; then
            echo "هیچ تغییری برای commit وجود ندارد"
          else
            git commit -m "به‌روزرسانی اندپوینت‌های WARP [$(date '+%Y-%m-%d %H:%M')]"
            git push
          fi
        continue-on-error: true
        
      - name: Debug info
        if: always()
        run: |
          echo "=== اطلاعات دیباگ ==="
          echo "دایرکتوری فعلی: $(pwd)"
          echo "فایل‌های موجود:"
          ls -la
          echo "=== اینترفیس‌های شبکه ==="
          ip addr show
          echo "=== فضاهای نام شبکه ==="
          ip netns list
          echo "=== فایل‌های باینری ==="
          ls -la /tmp/warp* 2>/dev/null || echo "فایل‌های باینری یافت نشد"
          echo "=== محتوای warp_results.txt ==="
          cat warp_results.txt || echo "فایل warp_results.txt یافت نشد"
          echo "=== محتوای best_endpoints.txt ==="
          cat best_endpoints.txt || echo "فایل best_endpoints.txt یافت نشد"
          echo "=== محتوای endpoints.json ==="
          cat endpoints.json || echo "فایل endpoints.json یافت نشد"
          
      - name: Cleanup
        if: always()
        run: |
          # حذف فضای نام مجازی و اینترفیس‌ها
          sudo ip link del veth0 2>/dev/null || true
          sudo ip netns del warpns 2>/dev/null || true
          
          # غیرفعال کردن forwarding
          sudo sysctl -w net.ipv4.ip_forward=0
          
          # حذف قوانین NAT
          sudo iptables -t nat -D POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE 2>/dev/null || true
          
          # حذف فایل‌های موقت
          sudo rm -rf /tmp/warp* 2>/dev/null || true
