name: Warp-Go Endpoint Generator

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # هر 6 ساعت یکبار

jobs:
  generate-endpoint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        mkdir -p warp-workspace
        cd warp-workspace
        sudo apt-get update
        sudo apt-get install -y wget curl jq net-tools
    
    - name: Check and download warp-go files
      working-directory: warp-workspace
      run: |
        echo "=== Downloading from original source ==="
        wget -O warp-go_1.0.8_linux_amd64.tar.gz https://gitlab.com/fscarmen/warp/-/raw/main/warp-go/warp-go_1.0.8_linux_amd64.tar.gz
        
        if [ -f "../warp-go.sh" ]; then
          cp ../warp-go.sh .
        else
          cat > warp-go.sh << 'EOF'
        #!/bin/bash
        if [ -f "warp-go_1.0.8_linux_amd64.tar.gz" ]; then
          tar -xzf warp-go_1.0.8_linux_amd64.tar.gz
          chmod +x warp-go
          ./warp-go --socks5 0.0.0.0:40000
        else
          echo "Error: warp-go archive not found"
          exit 1
        fi
        EOF
        fi
        
        chmod +x warp-go.sh
        tar -xzf warp-go_1.0.8_linux_amd64.tar.gz
        chmod +x warp-go
        
        echo "=== Files in workspace ==="
        ls -la
    
    - name: Analyze warp-go
      working-directory: warp-workspace
      run: |
        echo "=== warp-go version and help ==="
        ./warp-go --version 2>&1 || true
        ./warp-go --help 2>&1 || true
    
    - name: Run warp-go and capture endpoint
      id: warp
      working-directory: warp-workspace
      run: |
        echo "=== Starting warp-go ==="
        
        # اجرای warp-go با دسترسی sudo برای مدیریت شبکه
        echo "Method 1: Direct execution with sudo"
        timeout 60s sudo ./warp-go --socks5 0.0.0.0:40000 > direct_output.log 2>&1 &
        WARP_PID=$!
        
        sleep 15
        
        echo "=== Checking ports ==="
        sudo netstat -tlnp | grep -E "40000|warp" || true
        
        ENDPOINT=""
        if sudo netstat -tlnp | grep -q "40000"; then
          ENDPOINT="socks5://127.0.0.1:40000"
          echo "Found endpoint: $ENDPOINT"
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
        fi
        
        echo "=== Direct output log ==="
        cat direct_output.log || true
        
        kill $WARP_PID 2>/dev/null || true
        
        if [ -z "$ENDPOINT" ]; then
          echo "=== Method 2: Script execution with sudo ==="
          timeout 60s sudo bash warp-go.sh > script_output.log 2>&1 &
          SCRIPT_PID=$!
          
          sleep 15
          
          sudo netstat -tlnp | grep -E "1080|8080|40000" || true
          cat script_output.log || true
          
          ENDPOINT=$(grep -o "socks5://[^ ]*\|http://[^ ]*" script_output.log | head -1 || echo "")
          if [ -n "$ENDPOINT" ]; then
            echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          fi
          
          kill $SCRIPT_PID 2>/dev/null || true
        fi
        
        pkill -f warp-go 2>/dev/null || true
    
    - name: Test endpoint if found
      if: steps.warp.outputs.endpoint != ''
      working-directory: warp-workspace
      run: |
        echo "=== Testing endpoint: ${{ steps.warp.outputs.endpoint }} ==="
        
        # اجرای مجدد warp-go با sudo برای تست
        sudo ./warp-go --socks5 0.0.0.0:40000 > test_output.log 2>&1 &
        WARP_PID=$!
        sleep 10
        
        curl -x ${{ steps.warp.outputs.endpoint }} -m 10 https://api.ipify.org?format=json || true
        echo ""
        curl -x ${{ steps.warp.outputs.endpoint }} -m 10 https://httpbin.org/ip || true
        
        kill $WARP_PID 2>/dev/null || true
    
    - name: Generate endpoint report
      if: always()
      working-directory: warp-workspace
      run: |
        cat > endpoint_report.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "run_id": "${{ github.run_id }}",
          "run_number": "${{ github.run_number }}",
          "endpoint": "${{ steps.warp.outputs.endpoint }}",
          "status": "${{ steps.warp.outputs.endpoint != '' && 'success' || 'failed' }}"
        }
        EOF
        echo "=== Endpoint Report ==="
        cat endpoint_report.json | jq .
    
    - name: Upload all artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: warp-artifacts-${{ github.run_number }}
        path: |
          warp-workspace/*.log
          warp-workspace/*.json
    
    - name: Create GitHub Release with endpoint
      if: steps.warp.outputs.endpoint != ''
      uses: ncipollo/release-action@v1
      with:
        tag: endpoint-${{ github.run_number }}
        name: Warp Endpoint - ${{ github.run_number }}
        body: |
          **Endpoint:** `${{ steps.warp.outputs.endpoint }}`
          **Generated at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Run ID:** ${{ github.run_id }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
    
    - name: Update ENDPOINTS.md
      if: steps.warp.outputs.endpoint != ''
      run: |
        cat > ENDPOINTS.md << EOF
        # Latest Warp-Go Endpoint
        
        \`\`\`
        ${{ steps.warp.outputs.endpoint }}
        \`\`\`
        
        **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ENDPOINTS.md
        git commit -m "Update endpoint - Run #${{ github.run_number }}" || echo "No changes to commit"
        git push || echo "Push failed"
    
    - name: Final status
      if: always()
      run: |
        echo "=== Workflow Summary ==="
        if [ "${{ steps.warp.outputs.endpoint }}" != "" ]; then
          echo "✅ Successfully generated endpoint: ${{ steps.warp.outputs.endpoint }}"
        else
          echo "❌ Failed to generate endpoint"
        fi
