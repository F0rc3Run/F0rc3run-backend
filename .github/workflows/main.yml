name: Test IP Change with Cloudflare WARP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-ip-change:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Show initial IP
        run: |
          echo "ğŸŒ IP Ù‚Ø¨Ù„ Ø§Ø² Ø§ØªØµØ§Ù„ Ø¨Ù‡ WARP:"
          echo "----------------------------"
          curl -s https://ipinfo.io/json | jq -r '"IP: " + .ip + "\nCity: " + .city + "\nRegion: " + .region + "\nCountry: " + .country + "\nOrg: " + .org'
          echo ""
          echo "IP Ø§Ø² Ù…Ù†Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±:"
          curl -s https://api.ipify.org?format=json | jq -r '"IP: " + .ip'
          echo "----------------------------"
          
      - name: Install Cloudflare WARP
        run: |
          echo "ğŸ“¦ Ù†ØµØ¨ Cloudflare WARP..."
          # Ø§ÙØ²ÙˆØ¯Ù† GPG key
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          
          # Ø§ÙØ²ÙˆØ¯Ù† repository
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          
          # Ù†ØµØ¨
          sudo apt-get update
          sudo apt-get install -y cloudflare-warp
          
      - name: Configure and Connect WARP
        run: |
          echo "âš™ï¸ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ WARP..."
          # Ø«Ø¨Øª Ù†Ø§Ù…
          yes | warp-cli --accept-tos register || true
          
          # ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª proxy
          warp-cli --accept-tos mode proxy
          
          # Ø§ØªØµØ§Ù„
          warp-cli --accept-tos connect
          
          # ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ú©Ø§Ù…Ù„
          echo "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„..."
          sleep 10
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
          echo "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª WARP:"
          warp-cli --accept-tos status
          
      - name: Show IP after WARP connection
        run: |
          echo ""
          echo "ğŸ”„ IP Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªØµØ§Ù„ Ø¨Ù‡ WARP:"
          echo "----------------------------"
          
          # ØªÙ†Ø¸ÛŒÙ… proxy Ø¨Ø±Ø§ÛŒ curl
          export http_proxy=socks5://127.0.0.1:40000
          export https_proxy=socks5://127.0.0.1:40000
          
          # Ù†Ù…Ø§ÛŒØ´ IP Ø¬Ø¯ÛŒØ¯
          curl -s --proxy socks5://127.0.0.1:40000 https://ipinfo.io/json | jq -r '"IP: " + .ip + "\nCity: " + .city + "\nRegion: " + .region + "\nCountry: " + .country + "\nOrg: " + .org' || echo "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª IP"
          
          echo ""
          echo "IP Ø§Ø² Ù…Ù†Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±:"
          curl -s --proxy socks5://127.0.0.1:40000 https://api.ipify.org?format=json | jq -r '"IP: " + .ip' || echo "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª IP"
          echo "----------------------------"
          
      - name: Test with Python requests
        run: |
          echo ""
          echo "ğŸ ØªØ³Øª Ø¨Ø§ Python:"
          python3 -m pip install requests[socks]
          
          python3 << 'EOF'
          import requests
          import json
          
          # Ø¨Ø¯ÙˆÙ† proxy
          print("IP Ø¨Ø¯ÙˆÙ† WARP:")
          try:
              response = requests.get('https://httpbin.org/ip')
              print(json.dumps(response.json(), indent=2))
          except Exception as e:
              print(f"Ø®Ø·Ø§: {e}")
          
          print("\n" + "-"*40 + "\n")
          
          # Ø¨Ø§ proxy
          print("IP Ø¨Ø§ WARP:")
          proxies = {
              'http': 'socks5://127.0.0.1:40000',
              'https': 'socks5://127.0.0.1:40000'
          }
          
          try:
              response = requests.get('https://httpbin.org/ip', proxies=proxies)
              print(json.dumps(response.json(), indent=2))
          except Exception as e:
              print(f"Ø®Ø·Ø§: {e}")
          EOF
          
      - name: Disconnect WARP
        if: always()
        run: |
          echo "ğŸ”Œ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ WARP..."
          warp-cli --accept-tos disconnect || true
          
      - name: Final IP check
        if: always()
        run: |
          echo ""
          echo "âœ… IP Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù‚Ø·Ø¹ WARP:"
          echo "----------------------------"
          curl -s https://ipinfo.io/json | jq -r '"IP: " + .ip + "\nCountry: " + .country'
