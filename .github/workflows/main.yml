name: WARP Endpoint Scanner

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget iproute2 net-tools

      - name: Create virtual network interfaces
        run: |
          # ایجاد اینترفیس‌های مجازی IPv4 و IPv6
          sudo ip link add dummy0 type dummy
          sudo ip addr add 192.168.1.1/24 dev dummy0
          sudo ip link set dummy0 up
          
          sudo ip -6 addr add 2001:db8::1/64 dev dummy0
          sudo ip link set dummy0 up

      - name: Download warp script
        run: |
          curl -o warp-go.sh https://gitlab.com/fscarmen/warp/-/raw/main/warp-go.sh
          chmod +x warp-go.sh

      - name: Run warp scan with simulated network
        run: |
          echo "Starting WARP scan..."
          sudo ./warp-go.sh scan > warp_results.txt 2>&1 || echo "Scan completed with some errors"
          echo "WARP scan finished"
        continue-on-error: true

      - name: Process results
        run: |
          echo "Processing results..."
          # استخراج اندپوینت‌های سالم
          if grep -qE '^[0-9]' warp_results.txt; then
            grep -E '^[0-9]' warp_results.txt | head -20 > best_endpoints.txt
          else
            echo "No valid endpoints found" > best_endpoints.txt
          fi
          
          # ایجاد فایل JSON برای استفاده‌های بعدی
          echo "[" > endpoints.json
          if [ -s best_endpoints.txt ] && ! grep -q "No valid endpoints found" best_endpoints.txt; then
            grep -E '^[0-9]' best_endpoints.txt | while read line; do
              ip=$(echo $line | awk '{print $1}')
              port=$(echo $line | awk '{print $2}')
              ping=$(echo $line | awk '{print $3}')
              echo "  {\"ip\": \"$ip\", \"port\": \"$port\", \"ping\": \"$ping\"}," >> endpoints.json
            done
          fi
          echo "]" >> endpoints.json
          echo "Results processing completed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: warp-scan-results
          path: |
            warp_results.txt
            best_endpoints.txt
            endpoints.json
        continue-on-error: true

      - name: Commit results
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add best_endpoints.txt endpoints.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update warp endpoints [$(date '+%Y-%m-%d %H:%M')]"
            git push
          fi
        continue-on-error: true

      - name: Debug info
        if: always()
        run: |
          echo "=== Debug Information ==="
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          echo "=== Network interfaces ==="
          ip addr show
          echo "=== warp_results.txt (first 10 lines) ==="
          head -n 10 warp_results.txt || echo "warp_results.txt not found"
          echo "=== best_endpoints.txt (first 10 lines) ==="
          head -n 10 best_endpoints.txt || echo "best_endpoints.txt not found"
          echo "=== endpoints.json (first 10 lines) ==="
          head -n 10 endpoints.json || echo "endpoints.json not found"
